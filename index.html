<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kasir PT. BSV Marcela Groups ‚Äì v2.1 (Tanggal + Hapus Laporan)</title>
<style>
  body{font-family:Segoe UI,Arial,sans-serif;background:#0f172a;color:#e5e7eb;margin:0}
  header{background:#0ea5e9;color:#fff;padding:15px;text-align:center;font-weight:700}
  .container{max-width:960px;margin:auto;padding:20px}
  .card{background:#111827;border-radius:12px;padding:18px;margin-top:18px}
  input,select,button{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px}
  input,select{background:#e2e8f0;color:#000}
  button{background:#38bdf8;color:#002133;font-weight:700;cursor:pointer}
  button:hover{background:#0ea5e9}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #334155;padding:8px;text-align:left}
  th{background:#1e293b}
  td.editable:hover{background:#1e3a8a;cursor:pointer}
  .btn-danger{background:#ef4444;color:#fff}
  .btn-danger:hover{background:#dc2626}
  .right{text-align:right}.center{text-align:center}
  .muted{color:#94a3b8}
</style>
</head>
<body>
<header>üíº PT. BSV Marcela Groups ‚Äì Kasir Online Nanga Pinoh (v2.1)</header>

<!-- LOGIN -->
<div id="login" class="card container">
  <h3>üîê Login Kasir</h3>
  <input id="username" placeholder="Username (admin / kasir)">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Masuk</button>
  <p id="msg" style="color:#f87171"></p>
</div>

<!-- APP -->
<div id="app" class="container" style="display:none">
  <h2 id="welcome"></h2>

  <!-- POS -->
  <div class="card">
    <h3>üõí Transaksi Penjualan</h3>
    <select id="barang"></select>
    <input type="number" id="qty" value="1" min="1">
    <button onclick="tambah()">Tambah</button>

    <table>
      <thead>
        <tr><th>Barang</th><th class="center">Qty</th><th class="right">Harga Jual</th><th class="right">Total</th><th></th></tr>
      </thead>
      <tbody id="keranjang"></tbody>
      <tfoot><tr><th colspan="3" class="right">Subtotal</th><th id="subtotal" class="right">0</th><th></th></tr></tfoot>
    </table>

    <!-- Tanggal Transaksi (baru) -->
    <label class="muted">üìÖ Tanggal Transaksi</label>
    <input type="date" id="tglTransaksi">

    <button onclick="simpan()">Simpan & Cetak Nota</button>
  </div>

  <!-- STOK -->
  <div class="card">
    <h3>üì¶ Stok Barang</h3>
    <div id="stok"></div>

    <h4>Tambah Barang Baru</h4>
    <div id="formAdmin">
      <input id="namaBarang" placeholder="Nama Barang">
      <input id="hargaBeli" type="number" placeholder="Harga Beli (modal)">
      <input id="hargaJual" type="number" placeholder="Harga Jual">
      <input id="stokBarang" type="number" placeholder="Stok">
      <button onclick="tambahBarang()">Tambah Barang</button>
      <div class="muted">* Harga beli hanya terlihat untuk ADMIN.</div>
    </div>
    <div id="formKasir" class="muted" style="display:none">Hanya ADMIN yang dapat menambah/ubah harga beli & barang.</div>
  </div>

  <!-- LAPORAN -->
  <div class="card">
    <h3>üìà Laporan Ringkas</h3>
    <div class="grid">
      <label>Filter tanggal:</label>
      <input type="date" id="filterTanggal">
      <label>Filter bulan:</label>
      <input type="month" id="filterBulan">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="tampilLaporan()">Tampilkan Semua</button>
        <button onclick="filterLaporan()">Filter</button>
      </div>
    </div>
    <div id="laporan" style="margin-top:10px"></div>
    <div id="ringkas" class="muted" style="margin-top:8px"></div>
  </div>

  <button class="btn-danger" onclick="logout()">Logout</button>
</div>

<footer style="text-align:center;margin:20px" class="muted">¬© 2025 PT. BSV Marcela Groups</footer>

<script>
/* ========= Data & State ========= */
const users={admin:"admin123",kasir:"kasir123"};
let barangList=JSON.parse(localStorage.getItem("bsv_barang"))||[];
let laporan=JSON.parse(localStorage.getItem("bsv_laporan_v2"))||[]; // simpan total & laba per transaksi
let keranjang=[];
let SESSION=null;

const $=id=>document.getElementById(id);
const fmtID=n=>new Intl.NumberFormat('id-ID').format(n||0);
const todayISO=()=>{const d=new Date();const y=d.getFullYear(),m=("0"+(d.getMonth()+1)).slice(-2),dd=("0"+d.getDate()).slice(-2);return `${y}-${m}-${dd}`;}
const toDMY=(iso)=>{const [y,m,d]=iso.split("-");return `${d}/${m}/${y}`}

/* ========= Login ========= */
function login(){
  const u=$("username").value.trim().toLowerCase();
  const p=$("password").value.trim();
  if(users[u]===p){
    SESSION={username:u,role:(u==='admin'?'admin':'kasir')};
    $("login").style.display="none";
    $("app").style.display="block";
    $("welcome").innerText="üëã Selamat datang, "+u.toUpperCase()+" ("+SESSION.role+")";
    boot();
  }else{$("msg").innerText="Username atau password salah!";}
}
function logout(){ location.reload(); }

/* ========= Boot ========= */
function boot(){
  // pastikan tiap item punya hbeli
  barangList=(barangList||[]).map(b=>({nama:b.nama,hbeli:b.hbeli??0,harga:b.harga??b.hargaJual??0,stok:b.stok??0}));
  saveBarang();

  // tampil form sesuai role
  if(SESSION.role==='admin'){ $("formAdmin").style.display="block"; $("formKasir").style.display="none"; }
  else{ $("formAdmin").style.display="none"; $("formKasir").style.display="block"; }

  // inisialisasi tanggal transaksi (default hari ini)
  $("tglTransaksi").value = todayISO();

  tampilBarang(); tampilStok(); tampilLaporan();
}

/* ========= Barang & Stok ========= */
function saveBarang(){ localStorage.setItem("bsv_barang",JSON.stringify(barangList)); }

function tampilBarang(){
  const sel=$("barang"); sel.innerHTML="";
  if(!barangList.length){ sel.innerHTML="<option>(Belum ada barang)</option>"; return; }
  barangList.forEach((b,i)=>{
    const op=document.createElement("option");
    op.value=i; op.textContent=`${b.nama} ‚Äî Rp${fmtID(b.harga)} (Stok ${b.stok})`;
    sel.appendChild(op);
  });
}
function tampilStok(){
  const box=$("stok");
  if(!barangList.length){ box.innerHTML="<p>Belum ada barang, tambahkan di bawah.</p>"; return; }
  let thead = `<tr>
    <th>Nama</th>
    ${SESSION.role==='admin'?'<th class="right">Harga Beli</th>':''}
    <th class="right">Harga Jual</th>
    <th class="center">Stok</th>
    <th>Aksi</th>
  </tr>`;
  let rows="";
  barangList.forEach((b,i)=>{
    rows += `<tr>
      <td>${b.nama}</td>
      ${SESSION.role==='admin'?`<td class="right editable" onclick="editHbeli(${i})">Rp${fmtID(b.hbeli)}</td>`:""}
      <td class="right editable" onclick="editHjual(${i})">Rp${fmtID(b.harga)}</td>
      <td class="center editable" onclick="editStok(${i})">${b.stok}</td>
      <td><button class="btn-danger" onclick="hapusBarang(${i})">Hapus</button></td>
    </tr>`;
  });
  box.innerHTML=`<table><thead>${thead}</thead><tbody>${rows}</tbody></table>`;
}
function editHbeli(i){ if(SESSION.role!=='admin')return; const v=prompt("Harga BELI baru:",barangList[i].hbeli||0); if(v===null)return; const x=parseInt(v); if(!isNaN(x)){ barangList[i].hbeli=x; saveBarang(); tampilStok(); } }
function editHjual(i){ const v=prompt("Harga JUAL baru:",barangList[i].harga||0); if(v===null)return; const x=parseInt(v); if(!isNaN(x)){ barangList[i].harga=x; saveBarang(); tampilStok(); tampilBarang(); } }
function editStok(i){ const v=prompt("STOK baru:",barangList[i].stok||0); if(v===null)return; const x=parseInt(v); if(!isNaN(x)){ barangList[i].stok=x; saveBarang(); tampilStok(); tampilBarang(); } }
function hapusBarang(i){ if(confirm("Hapus barang ini?")){ barangList.splice(i,1); saveBarang(); tampilStok(); tampilBarang(); } }
function tambahBarang(){
  if(SESSION.role!=='admin') return alert("Hanya ADMIN yang bisa menambah barang.");
  const nama=$("namaBarang").value.trim();
  const hbeli=parseInt($("hargaBeli").value||"0");
  const hjual=parseInt($("hargaJual").value||"0");
  const stok=parseInt($("stokBarang").value||"0");
  if(!nama)return alert("Nama barang wajib diisi.");
  barangList.push({nama,hbeli:isNaN(hbeli)?0:hbeli,harga:isNaN(hjual)?0:hjual,stok:isNaN(stok)?0:stok});
  saveBarang(); $("namaBarang").value=$("hargaBeli").value=$("hargaJual").value=$("stokBarang").value=""; tampilBarang(); tampilStok();
}

/* ========= POS ========= */
function tambah(){
  if(!barangList.length) return alert("Belum ada barang di stok!");
  const idx=parseInt($("barang").value||"0");
  const qty=Math.max(1, parseInt($("qty").value||"1"));
  const b=barangList[idx]; if(!b) return;
  if(b.stok<qty) return alert("Stok tidak cukup!");
  b.stok-=qty;
  keranjang.push({nama:b.nama,hbeli:b.hbeli||0,harga:b.harga||0,qty,total:(b.harga||0)*qty});
  renderKeranjang(); tampilStok(); tampilBarang();
}
function renderKeranjang(){
  const body=$("keranjang"); body.innerHTML=""; let sub=0;
  keranjang.forEach((k,i)=>{ sub+=k.total;
    body.innerHTML+=`<tr>
      <td>${k.nama}</td><td class="center">${k.qty}</td>
      <td class="right">Rp${fmtID(k.harga)}</td><td class="right">Rp${fmtID(k.total)}</td>
      <td><button class="btn-danger" onclick="hapusItem(${i})">x</button></td>
    </tr>`;
  });
  $("subtotal").innerText="Rp"+fmtID(sub);
}
function hapusItem(i){
  const row=keranjang[i]; const b=barangList.find(x=>x.nama===row.nama);
  if(b) b.stok+=row.qty; keranjang.splice(i,1);
  renderKeranjang(); tampilStok(); tampilBarang();
}

function simpan(){
  if(!keranjang.length) return alert("Keranjang kosong!");
  const iso = $("tglTransaksi").value || todayISO();   // yyyy-mm-dd (dipilih/manual)
  const tgl = toDMY(iso);                               // dd/mm/yyyy (format penyimpanan)
  const jam = new Date().toLocaleTimeString("id-ID");

  // hitung subtotal & laba transaksi
  let subtotal=0, labaTrans=0;
  keranjang.forEach(k=>{ subtotal+=k.total; labaTrans+=((k.harga||0)-(k.hbeli||0))*k.qty; });

  laporan.push({ tgl, jam, total: subtotal, laba: labaTrans, items: keranjang });
  localStorage.setItem("bsv_laporan_v2", JSON.stringify(laporan));
  saveBarang();

  keranjang=[]; renderKeranjang();
  alert("Transaksi disimpan!");
  cetakNota(tgl, jam, subtotal);
  tampilLaporan();
}
function cetakNota(tgl,jam,total){
  const w=window.open("","nota","width=380,height=600");
  w.document.write(`<pre>üßæ PT. BSV Marcela Groups\nTanggal: ${tgl} ‚Ä¢ Jam: ${jam}\n-----------------\nTotal: Rp${fmtID(total)}\nTerima kasih üôè</pre>`); w.print();
}

/* ========= Laporan ========= */
function tampilLaporan(data=laporan){
  const box=$("laporan"), sum=$("ringkas");
  if(!data.length){ box.innerHTML="<p>Belum ada laporan.</p>"; sum.innerHTML=""; return; }

  // Rekap harian
  const map={}; data.forEach(r=>{ if(!map[r.tgl]) map[r.tgl]={total:0,laba:0}; map[r.tgl].total+=(r.total||r.sub||0); map[r.tgl].laba+=(r.laba||0); });

  // Urut terbaru dulu
  const dates=Object.keys(map).sort((a,b)=>{const [ad,am,ay]=a.split("/").map(Number);const [bd,bm,by]=b.split("/").map(Number);return new Date(by,bm-1,bd)-new Date(ay,am-1,ad);});

  // Render + tombol hapus (admin only)
  let html = `<table><thead><tr>
      <th>Tanggal</th><th class="right">Total Penjualan</th><th class="right">Total Laba</th><th>Aksi</th>
  </tr></thead><tbody>`;
  dates.forEach(t=>{
    const aksi = (SESSION && SESSION.role==='admin')
      ? `<button class="btn-danger" onclick="hapusLaporanTanggal('${t}')">üóëÔ∏è Hapus</button>`
      : `<span class="muted">‚Äî</span>`;
    html += `<tr>
      <td>${t}</td>
      <td class="right">Rp${fmtID(map[t].total)}</td>
      <td class="right">Rp${fmtID(map[t].laba)}</td>
      <td class="center">${aksi}</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  box.innerHTML = html;

  // Ringkasan total dari data yang tampil
  const grandTotal=data.reduce((a,b)=>a+(b.total||b.sub||0),0);
  const grandLaba =data.reduce((a,b)=>a+(b.laba||0),0);
  sum.innerHTML=`Total Penjualan (tampilan ini): <b>Rp${fmtID(grandTotal)}</b> ‚Ä¢ Total Laba: <b>Rp${fmtID(grandLaba)}</b>`;
}

function hapusLaporanTanggal(tgl){
  if(!SESSION || SESSION.role!=='admin') return alert("Hanya ADMIN yang bisa menghapus laporan.");
  if(!confirm("Hapus semua transaksi pada tanggal "+tgl+" ?")) return;
  laporan = laporan.filter(r=>r.tgl!==tgl);
  localStorage.setItem("bsv_laporan_v2", JSON.stringify(laporan));
  tampilLaporan();
  alert("Laporan tanggal "+tgl+" sudah dihapus.");
}

/* ========= Filter ========= */
function filterLaporan(){
  const tgl=$("filterTanggal").value; // yyyy-mm-dd
  const bln=$("filterBulan").value;   // yyyy-mm
  let data=laporan;

  if(tgl){
    const target=toDMY(tgl);
    data=data.filter(x=>x.tgl===target);
  }else if(bln){
    const [y,m]=bln.split("-");
    data=data.filter(x=>{const [,mm,yy]=x.tgl.split("/"); return yy===y && mm===m;});
  }
  tampilLaporan(data);
}
</script>
</body>
</html>
