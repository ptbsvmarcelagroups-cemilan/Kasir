<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kasir PT. BSV Marcela Groups ‚Äì v2.2 Final</title>

  <!-- ‚úÖ Anti-cache agar selalu versi terbaru tanpa ?v= -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ‚úÖ Loader untuk PWA (manifest + service worker) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('‚úÖ Service Worker aktif:', reg.scope))
          .catch(err => console.log('‚ùå Gagal SW', err));
      });
    }
  </script>

  <!-- ‚úÖ STYLE (warna dark+biru khas BSV) -->
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #0ea5e9;
      --btn: #38bdf8;
      --muted: #94a3b8;
      --border: #334155;
    }
    body { font-family: Arial, sans-serif; background: var(--bg); color: #e5e7eb; margin: 0; }
    header { background: var(--accent); padding: 14px; text-align: center; color: white; font-weight: bold; }
    .container { max-width: 1080px; margin: 0 auto; padding: 18px; }
    .card { background: var(--card); padding: 18px; border-radius: 12px; margin-top: 18px; }
    input, select, button { width: 100%; padding: 10px; margin: 6px 0; border: none; border-radius: 8px; }
    input, select { background: #e2e8f0; color: #000; }
    button.primary { background: var(--btn); color: #002133; font-weight: 600; cursor: pointer; }
    button.primary:hover { background: var(--accent); }
    button.danger { background: #ef4444; color: white; }
    button.danger:hover { background: #dc2626; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px; }
    th { background: #1e293b; }
    .hidden { display: none; }
  </style>
</head>
<body>

<header>üíº PT. BSV Marcela Groups ‚Äì Kasir Online (v2.2 Final)</header>
<div class="container">

  <!-- ‚úÖ LOGIN -->
  <div id="login" class="card">
    <h3>üîê Login</h3>
    <input id="username" placeholder="Username (default: admin)">
    <input id="password" type="password" placeholder="Password (admin123)">
    <button class="primary" onclick="login()">Masuk</button>
    <p id="msg" style="color:#f87171"></p>
  </div>

  <!-- ‚úÖ APP MULAI -->
  <div id="app" class="hidden">
    <h2 id="welcome"></h2>
    <div class="nav">
      <button id="tab-pos" class="active" onclick="showTab('pos')">üõí Transaksi</button>
      <button id="tab-stok" onclick="showTab('stok')">üì¶ Stok</button>
      <button id="tab-lap" onclick="showTab('lap')">üìà Laporan</button>
      <button id="tab-keu" onclick="showTab('keu')">üí∏ Pemasukan-Pengeluaran</button>
      <button id="tab-user" onclick="showTab('user')">üë• User</button>
      <button class="danger" style="margin-left:auto" onclick="logout()">Logout</button>
    </div>

    <!-- ‚úÖ Mulai halaman transaksi -->
    <div id="sec-pos" class="card">
      <h3>üõí Transaksi Penjualan</h3>
      <select id="barang"></select>
      <input id="qty" type="number" value="1" min="1">
      <button class="primary" onclick="tambah()">Tambah</button>
      <table>
        <thead>
          <tr>
            <th>Barang</th>
            <th class="center">Qty</th>
            <th class="right">Harga</th>
            <th class="right">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="keranjang"></tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="right">Subtotal</th>
            <th id="subtotal" class="right">Rp0</th>
            <th></th>
          </tr>
        </tfoot>
      </table>

      <label class="muted">üìÖ Tanggal Transaksi</label>
      <input type="date" id="tglTransaksi">
      <button class="primary" onclick="simpan()">Simpan & Cetak Nota</button>
    </div>

    <!-- ‚úÖ STOK -->
    <div id="sec-stok" class="card hidden">
      <h3>üì¶ Stok Barang</h3>
      <div id="stok"></div>

      <h4>Tambah Barang</h4>
      <input id="namaBarang" placeholder="Nama Barang">
      <input id="hargaBeli" type="number" placeholder="Harga Beli">
      <input id="hargaJual" type="number" placeholder="Harga Jual">
      <input id="stokBarang" type="number" placeholder="Stok">
      <button class="primary" onclick="tambahBarang()">Tambah</button>
    </div>

    <!-- ‚úÖ LAPORAN PENJUALAN -->
    <div id="sec-lap" class="card hidden">
      <h3>üìà Laporan Penjualan</h3>

      <label>Filter Tanggal</label>
      <input type="date" id="filterTanggalLap">
      <label>Filter Bulan</label>
      <input type="month" id="filterBulanLap">
      <button onclick="tampilLaporan()">Tampilkan Semua</button>
      <button class="primary" onclick="filterLaporan()">Filter</button>

      <div id="laporan" style="margin-top:10px"></div>
      <div id="ringkas" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- ‚úÖ PEMASUKAN PENGELUARAN -->
    <div id="sec-keu" class="card hidden">
      <h3>üí∏ Pemasukan & Pengeluaran</h3>
      <input type="date" id="keuTanggal">
      <select id="keuJenis">
        <option value="pemasukan">Pemasukan</option>
        <option value="pengeluaran">Pengeluaran</option>
      </select>
      <input id="keuKet" placeholder="Keterangan">
      <input type="number" id="keuNominal" placeholder="Nominal">
      <button class="primary" onclick="keuTambah()">Tambah</button>

      <label>Filter Tanggal</label>
      <input type="date" id="keuFilterTanggal">
      <label>Filter Bulan</label>
      <input type="month" id="keuFilterBulan">
      <button onclick="keuTampil()">Semua</button>
      <button class="primary" onclick="keuFilter()">Filter</button>

      <div id="keuTabel" style="margin-top:10px"></div>
      <div id="keuRingkas" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- ‚úÖ USER -->
    <div id="sec-user" class="card hidden">
      <h3>üë• Manajemen User</h3>
      <input id="userNewName" placeholder="Username baru">
      <input id="userNewPass" placeholder="Password baru">
      <button class="primary" onclick="userAdd()">Tambah User</button>
      <div id="userTable" style="margin-top:10px"></div>
    </div>

  </div> <!-- /app -->
</div> <!-- /container -->

<footer style="text-align:center;margin:20px" class="muted">¬© 2025 PT. BSV Marcela Groups</footer>

<!-- ‚úÖ SCRIPT JAVASCRIPT -->
<script>
const $ = id => document.getElementById(id);
const fmtID = n => new Intl.NumberFormat('id-ID').format(n || 0);
const todayISO = () => {
  const d = new Date();
  return \`\${d.getFullYear()}-\${String(d.getMonth()+1).padStart(2,'0')}-\${String(d.getDate()).padStart(2,'0')}\`;
};
const toDMY = iso => {
  const [y,m,d] = iso.split('-');
  return \`\${d}/\${m}/\${y}\`;
};
const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

let USERS = JSON.parse(localStorage.getItem('bsv_users')) || [{username:'admin',password:'admin123'}];
let barangList = JSON.parse(localStorage.getItem('bsv_barang')) || [];
let laporan = JSON.parse(localStorage.getItem('bsv_laporan_v2')) || [];
let keu = JSON.parse(localStorage.getItem('bsv_keu_v22')) || [];
let keranjang = [];
let SESSION = null;

const saveUsers = () => localStorage.setItem('bsv_users',JSON.stringify(USERS));
const saveBarang = () => localStorage.setItem('bsv_barang',JSON.stringify(barangList));
const saveLap = () => localStorage.setItem('bsv_laporan_v2',JSON.stringify(laporan));
const saveKeu = () => localStorage.setItem('bsv_keu_v22',JSON.stringify(keu));

function login(){
  const u = $('username').value.trim();
  const p = $('password').value.trim();
  const user = USERS.find(x=>x.username===u && x.password===p);
  if(!user){ $('msg').innerText = 'Username atau password salah'; return; }
  SESSION = {username: u};
  $('login').classList.add('hidden');
  $('app').classList.remove('hidden');
  $('welcome').innerText = 'üëã Selamat datang, ' + u.toUpperCase();
  $('tglTransaksi').value = todayISO();
  tampilBarang(); tampilStok(); tampilLaporan(); keuTampil(); userRender();
}

function logout(){ location.reload(); }

function showTab(name){
  ['pos','stok','lap','keu','user'].forEach(n=>{
    $('sec-'+n).classList.toggle('hidden', n!==name);
    $('tab-'+n).classList.toggle('active', n===name);
  });
}

/* === Transaksi === */
function tampilBarang(){
  const sel = $('barang'); sel.innerHTML = '';
  barangList.forEach((b,i)=>{
    sel.innerHTML += \`<option value="\${i}">\${b.nama} - Rp\${fmtID(b.harga)} (Stok \${b.stok})</option>\`;
  });
}

function tambah(){
  const idx = $('barang').value;
  if(idx === null) return;
  const qty = parseInt($('qty').value);
  const b = barangList[idx];
  if(b.stok < qty) return alert('Stok tidak cukup!');
  b.stok -= qty;
  keranjang.push({
    nama: b.nama,
    hbeli: b.hbeli || 0,
    harga: b.harga,
    qty,
    total: b.harga * qty
  });
  saveBarang();
  renderKeranjang(); tampilBarang();
}

function renderKeranjang(){
  $('keranjang').innerHTML = '';
  let total = 0;
  keranjang.forEach((k,i)=>{
    total += k.total;
    $('keranjang').innerHTML += \`
      <tr>
        <td>\${k.nama}</td>
        <td class="center">\${k.qty}</td>
        <td class="right">Rp\${fmtID(k.harga)}</td>
        <td class="right">Rp\${fmtID(k.total)}</td>
        <td><button class="danger" onclick="hapusItem(\${i})">x</button></td>
      </tr>\`;
  });
  $('subtotal').innerText = 'Rp' + fmtID(total);
}

function hapusItem(i){
  const row = keranjang[i];
  const b = barangList.find(x=>x.nama===row.nama);
  if(b) b.stok += row.qty;
  keranjang.splice(i,1);
  saveBarang(); renderKeranjang(); tampilBarang();
}

function simpan(){
  if(!keranjang.length) return alert('Keranjang kosong!');
  const iso = $('tglTransaksi').value || todayISO();
  const tgl = toDMY(iso);
  const jam = new Date().toLocaleTimeString('id-ID');

  let total = 0, laba = 0;
  keranjang.forEach(k=>{
    total += k.total;
    laba += (k.harga - k.hbeli) * k.qty;
  });

  laporan.push({tgl, jam, total, laba, items: keranjang});
  saveLap();

  keu.push({id: uuid(), tgl, jenis:'pemasukan', ket:'Penjualan Harian', nominal: total});
  saveKeu();

  keranjang = [];
  renderKeranjang(); tampilLaporan(); keuTampil();
  alert('Transaksi berhasil!');
}

/* === Stok === */
function tampilStok(){
  let html = '<table><tr><th>Barang</th><th>Beli</th><th>Jual</th><th>Stok</th><th>Aksi</th></tr>';
  barangList.forEach((b,i)=>{
    html += \`<tr>
      <td>\${b.nama}</td>
      <td class="right">\${fmtID(b.hbeli || 0)}</td>
      <td class="right">\${fmtID(b.harga)}</td>
      <td class="center">\${b.stok}</td>
      <td><button class="danger" onclick="hapusBarang(\${i})">Hapus</button></td>
    </tr>\`;
  });
  html += '</table>';
  $('stok').innerHTML = html;
}

function tambahBarang(){
  const nama = $('namaBarang').value;
  const hbeli = parseInt($('hargaBeli').value||0);
  const harga = parseInt($('hargaJual').value||0);
  const stok = parseInt($('stokBarang').value||0);
  if(!nama) return alert('Nama barang kosong');
  barangList.push({nama, hbeli, harga, stok});
  saveBarang();
  $('namaBarang').value = $('hargaBeli').value = $('hargaJual').value = $('stokBarang').value = '';
  tampilBarang(); tampilStok();
}

function hapusBarang(i){
  if(confirm('Hapus barang ini?')){
    barangList.splice(i,1);
    saveBarang(); tampilStok(); tampilBarang();
  }
}

/* === Laporan === */
function tampilLaporan(data=laporan){
  let html = '<table><tr><th>Tanggal</th><th>Total</th><th>Laba</th><th>Aksi</th></tr>';
  let total = 0, laba = 0;
  data.forEach(r=>{
    total += r.total; laba += r.laba;
    html += \`<tr>
      <td>\${r.tgl}</td>
      <td class="right">Rp\${fmtID(r.total)}</td>
      <td class="right">Rp\${fmtID(r.laba)}</td>
      <td><button class="danger" onclick="hapusLap('\${r.tgl}')">Hapus</button></td>
    </tr>\`;
  });
  html += '</table>';
  $('laporan').innerHTML = html;
  $('ringkas').innerHTML = \`Total: Rp\${fmtID(total)} | Laba: Rp\${fmtID(laba)}\`;
}

function filterLaporan(){
  const t = $('filterTanggalLap').value;
  const b = $('filterBulanLap').value;
  if(t){
    tampilLaporan(laporan.filter(x=>x.tgl===toDMY(t)));
  } else if(b){
    const [yy,mm] = b.split('-');
    tampilLaporan(laporan.filter(x=>x.tgl.endsWith(\`\${mm}/\${yy}\`)));
  }
}

function hapusLap(tgl){
  if(confirm('Hapus semua transaksi tanggal '+tgl+'?')){
    laporan = laporan.filter(r=>r.tgl!==tgl);
    saveLap(); tampilLaporan();
  }
}

/* === Keuangan === */
function keuTampil(data=keu){
  let html = '<table><tr><th>Tgl</th><th>Ket</th><th>Jenis</th><th>Nominal</th><th>Aksi</th></tr>', inTotal=0,outTotal=0;
  data.forEach(item=>{
    html += \`<tr>
      <td>\${item.tgl}</td>
      <td>\${item.ket}</td>
      <td>\${item.jenis}</td>
      <td class="right">Rp\${fmtID(item.nominal)}</td>
      <td><button class="danger" onclick="keuDel('\${item.id}')">x</button></td>
    </tr>\`;
    if(item.jenis==='pemasukan') inTotal+=item.nominal; else outTotal+=item.nominal;
  });
  html += '</table>';
  $('keuTabel').innerHTML = html;
  $('keuRingkas').innerHTML = \`Pemasukan: Rp\${fmtID(inTotal)} | Pengeluaran: Rp\${fmtID(outTotal)} | Saldo: Rp\${fmtID(inTotal-outTotal)}\`;
}

function keuTambah(){
  const iso = $('keuTanggal').value || todayISO();
  keu.push({
    id: uuid(),
    tgl: toDMY(iso),
    jenis: $('keuJenis').value,
    ket: $('keuKet').value || '-',
    nominal: parseInt($('keuNominal').value)
  });
  saveKeu(); keuTampil();
}

/* === User Management === */
function userRender(){
  let html = '<table><tr><th>User</th><th>Aksi</th></tr>';
  USERS.forEach(u=>{
    html += \`<tr>
      <td>\${u.username}</td>
      <td>
        ${"`"}<button onclick="userDel('\${u.username}')">Hapus</button>${"`"}
      </td>
    </tr>\`;
  });
  html += '</table>';
  $('userTable').innerHTML = html;
}

function userAdd(){
  USERS.push({username: $('userNewName').value, password: $('userNewPass').value});
  saveUsers(); userRender();
}

function userDel(u){
  USERS = USERS.filter(x=>x.username!==u);
  saveUsers(); userRender();
}
</script>

</body>
</html>
